<!doctype html>
<html lang="vi" data-lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1" />
  <title>Client Gallery ‚Äì Photographer</title>
  <meta name="description" content="T·∫°o link chia s·∫ª album cho kh√°ch c√≥ m·∫≠t kh·∫©u v√† xu·∫•t danh s√°ch h√¨nh ∆∞a th√≠ch ‚Äì ch·∫°y tr√™n GitHub Pages" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <!-- Fonts: Poppins (VI/EN), Bayon + Siemreap (Khmer) -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Bayon&family=Siemreap&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg1:#0b1020;--bg2:#0e1326;--card:#12192e;--muted:#aab3c5;--brand:#7c9aff;--brand2:#5df2d6;--ok:#7ef78f;--warn:#ffce6b;--err:#ff7f7f;
      --text:#eaf0ff; --soft:#0f1530a6; --line:#2a355a;
    }
    /* Light theme overrides */
    :root.light{
      --bg1:#f5f7ff; --bg2:#e9eeff; --card:#ffffff; --muted:#4c5a79; --brand:#3358ff; --brand2:#0ab39c;
      --text:#0c1230; --soft:#ffffffcc; --line:#d7def3;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    /* Font families theo ng√¥n ng·ªØ, kho√° line-height ƒë·ªÉ kh√¥ng ƒë·ªïi k√≠ch th∆∞·ªõc */
    html[data-lang="vi"] body,
    html[data-lang="en"] body{font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial; line-height:1.5}
    html[data-lang="kh"] body{font-family:Siemreap,Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial; line-height:1.5}
    /* Ti√™u ƒë·ªÅ Khmer d√πng Bayon, gi·ªØ size/line-height c·ªë ƒë·ªãnh */
    h1,h2{line-height:1.25}
    html[data-lang="kh"] h1,
    html[data-lang="kh"] h2{font-family:Bayon,Siemreap,Poppins,system-ui}

    body{
      margin:0;
      background:radial-gradient(1200px 600px at 10% -10%,#1a2150 0%,var(--bg1) 45%,#070b18 100%);color:var(--text);
      transition:background .25s ease,color .25s ease;
    }
    :root.light body{ background:linear-gradient(180deg,var(--bg1),var(--bg2)) }

    a{color:var(--brand)}
    .container{max-width:1100px;margin:0 auto;padding:24px}

    /* NAV */
    .nav{display:flex;gap:12px;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:10}
    .pill{padding:8px 14px;border:1px solid var(--line);border-radius:999px;background:var(--soft);backdrop-filter:blur(6px);color:var(--text)}
    .actions{display:flex;gap:8px;align-items:center}
    .iconbtn{
      width:42px;height:42px;border-radius:12px;border:1px solid var(--line);
      background:linear-gradient(180deg,#18224a,#111834);display:inline-flex;align-items:center;justify-content:center;
      color:var(--text);cursor:pointer;user-select:none;touch-action:manipulation
    }
    :root.light .iconbtn{ background:#fff }
    .iconbtn:hover{filter:brightness(1.06)}
    .iconbtn svg{width:20px;height:20px}

    /* Language menu */
    .langwrap{position:relative}
    .langMenu{
      position:absolute; right:0; top:48px; min-width:160px;
      background:var(--soft); border:1px solid var(--line); border-radius:12px; padding:6px;
      backdrop-filter:blur(8px);
      box-shadow:0 8px 24px rgba(0,0,0,.3);
    }
    .langMenu.hidden{display:none}
    .langItem{
      display:flex; align-items:center; gap:10px; width:100%;
      padding:10px 12px; border-radius:10px; border:1px solid transparent;
      background:transparent; color:var(--text); cursor:pointer; font-size:14px; line-height:1.3;
    }
    .langItem:hover{background:rgba(255,255,255,.06); border-color:var(--line)}
    .flag{font-size:18px; width:20px}

    .hero{padding:28px 0 8px}
    h1{font-size:32px;margin:0 0 8px}
    h2{font-size:22px;margin:20px 0 10px}
    .card{background:linear-gradient(180deg,#121a36 0%,#0f162e 100%);border:1px solid var(--line);border-radius:16px;padding:18px}
    :root.light .card{background:#fff}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    label{display:block;font-weight:600;margin:6px 0 6px}
    /* Fix zoom iOS: gi·ªØ font-size >=16 */
    input,select,textarea,button{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #344168;background:#0c1430;color:#e7ecff;font-size:16px}
    :root.light input,:root.light textarea,:root.light button{background:#f5f7ff;color:#0c1230;border-color:#cbd6ff}
    input::placeholder,textarea::placeholder{color:#90a0c0}
    .hint{font-size:12px;color:var(--muted)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .gallery{--col:3;display:grid;grid-template-columns:repeat(var(--col),1fr);gap:12px}
    @media (max-width:900px){.row{grid-template-columns:1fr}.gallery{--col:2}}
    @media (max-width:560px){.gallery{--col:1}}
    .imgCard{position:relative;border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#0b1020}
    :root.light .imgCard{background:#eaf0ff}
    .imgCard img{display:block;width:100%;height:260px;object-fit:cover;background:#0b1020}
    /* T√™n file: g√≥c d∆∞·ªõi ph·∫£i */
    .imgTop{position:absolute;inset:auto 8px 8px auto;display:flex;gap:8px;max-width:75%}
    .tag{padding:6px 8px;border-radius:999px;background:#0d1535b0;border:1px solid var(--line);font-size:12px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:#eaf0ff}
    :root.light .tag{background:#0000003a;color:#fff;border-color:#ffffff80}
    /* Checkbox ·ªü g√≥c tr√™n tr√°i */
    .fav{position:absolute;left:8px;top:8px;display:flex;gap:8px;align-items:center}
    .fav input{width:22px;height:22px;border-radius:6px}
    .counter{font-weight:700}
    .toast{position:fixed;right:18px;bottom:18px;background:#121a36;border:1px solid var(--line);border-radius:12px;padding:12px 14px;display:none;max-width:80vw;color:#eaf0ff}
    :root.light .toast{background:#2a355a;color:#fff}
    .hidden{display:none !important}
    .sep{height:1px;background:linear-gradient(90deg,transparent,var(--line),transparent);margin:16px 0}
    .small{font-size:12px}
    .danger{color:var(--err)}
    /* N√∫t t·∫£i xu·ªëng: g√≥c tr√™n ph·∫£i */
    .imgActions{position:absolute;right:8px;top:8px;display:flex;gap:8px}
    .dlbtn{display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:10px;border:1px solid var(--line);background:#0d1535b0;backdrop-filter:blur(6px);cursor:pointer;color:#fff}
    .dlbtn svg{width:18px;height:18px}
    .note{display:block;width:100%;margin-top:8px;background:#0c1430;border:1px solid #344168;border-radius:10px;padding:10px 12px;color:#e7ecff}
    :root.light .note{background:#f6f8ff;color:#0c1230;border-color:#cbd6ff}
    /* Footer */
    footer{margin:24px auto 8px;max-width:1100px;padding:8px 24px;color:#aab3c5;text-align:center;font-size:12px}
  </style>
</head>
<body>
  <div class="container">
    <div class="nav">
      <div class="pill mono" id="brand">CLIENT GALLERY ¬∑ GIAUKIEN</div>

      <!-- ICON BAR -->
      <div class="actions">
        <!-- Home -->
        <button class="iconbtn" id="goHome" title="Trang ch·ªß" aria-label="Trang ch·ªß">
          <svg viewBox="0 0 24 24" fill="none"><path d="M3 11l9-8 9 8v8a2 2 0 0 1-2 2h-4v-6H9v6H5a2 2 0 0 1-2-2v-8z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
        <!-- Admin / Create link -->
        <button class="iconbtn" id="goAdmin" title="T·∫°o link cho kh√°ch" aria-label="T·∫°o link">
          <svg viewBox="0 0 24 24" fill="none"><path d="M10 13a5 5 0 0 0 7.07 0l2.12-2.12a5 5 0 1 0-7.07-7.07L10.5 5M14 11a5 5 0 0 0-7.07 0L4.8 13.12a5 5 0 1 0 7.07 7.07L13.5 19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
        <!-- Language (globe) ‚Äì menu -->
        <div class="langwrap">
          <button class="iconbtn" id="toggleLang" title="Ti·∫øng Vi·ªát" aria-label="Ti·∫øng Vi·ªát">
            <svg viewBox="0 0 24 24" fill="none">
              <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/>
              <path d="M3 12h18M12 3a15 15 0 0 1 0 18M12 3a15 15 0 0 0 0 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
          <div id="langMenu" class="langMenu hidden" role="menu" aria-label="Languages">
            <button class="langItem" data-lang="vi"><span class="flag">üáªüá≥</span>Ti·∫øng Vi·ªát</button>
            <button class="langItem" data-lang="en"><span class="flag">üá¨üáß</span>English</button>
            <button class="langItem" data-lang="kh"><span class="flag">üá∞üá≠</span>·ûó·û∂·ûü·û∂·ûÅ·üí·ûò·üÇ·ûö</button>
          </div>
        </div>
        <!-- Theme toggle -->
        <button class="iconbtn" id="toggleTheme" title="S√°ng/T·ªëi" aria-label="ƒê·ªïi giao di·ªán">
          <svg id="themeIcon" viewBox="0 0 24 24" fill="none"><path d="M12 3a9 9 0 1 0 9 9c0-.34-.02-.68-.06-1A7 7 0 0 1 12 3z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
      </div>
    </div>

    <!-- HOME -->
    <div class="hero" id="homeView">
      <h1 id="t_home_title">Chia s·∫ª album cho kh√°ch</h1>
      <p class="hint" id="t_home_hint">Single-file ¬∑ ch·∫°y tr√™n GIAUKIEN ¬∑ d√πng Google Drive ƒë·ªÉ l∆∞u ·∫£nh ¬∑ kh√°ch xem/ t·∫£i/ ch·ªçn ·∫£nh y√™u th√≠ch.</p>
      <div class="sep"></div>
      <div class="row">
        <div class="card">
          <h2 id="t_card_make_title">T·∫°o link cho kh√°ch</h2>
          <p id="t_card_make_desc">V√†o ph·∫ßn <strong>T·∫°o link</strong> ƒë·ªÉ nh·∫≠p <em>API Key</em>, <em>Folder ID</em> c·ªßa Google Drive, ƒë·∫∑t <em>m·∫≠t kh·∫©u</em> v√† <em>gi·ªõi h·∫°n s·ªë ·∫£nh ƒë∆∞·ª£c ch·ªçn</em>. H·ªá th·ªëng s·∫Ω t·∫°o URL ri√™ng g·ª≠i cho kh√°ch.</p>
          <button class="iconbtn" id="ctaAdmin" title="M·ªü tr√¨nh t·∫°o link">
            <svg viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          </button>
          <p class="hint" id="t_card_make_note">L∆∞u √Ω: v√¨ ch·∫°y tƒ©nh tr√™n Pages, m·∫≠t kh·∫©u ch·ªâ ki·ªÉm tra ·ªü tr√¨nh duy·ªát (kh√¥ng ch·ªëng ƒë∆∞·ª£c ng∆∞·ªùi r√†nh k·ªπ thu·∫≠t). N·∫øu b·∫°n c·∫ßn b·∫£o v·ªá th·∫≠t s·ª±, n√™n d√πng server/ serverless.</p>
        </div>
        <div class="card">
          <h2 id="t_card_client_title">Kh√°ch truy c·∫≠p</h2>
          <p id="t_card_client_desc">N·∫øu b·∫°n l√† kh√°ch, b·∫°n s·∫Ω nh·∫≠n 1 ƒë∆∞·ªùng link. M·ªü link, nh·∫≠p m·∫≠t kh·∫©u l√† th·∫•y ·∫£nh.</p>
        </div>
      </div>
    </div>

    <!-- ADMIN -->
    <div id="adminView" class="hidden">
      <h1 id="t_admin_title">Tr√¨nh t·∫°o link cho kh√°ch</h1>
      <div class="card">
        <div class="row">
          <div>
            <label id="t_label_album">T√™n album</label>
            <input id="albumName" placeholder="VD: Wedding, GiauKien, ..."/>
          </div>
          <div>
            <label id="t_label_limit">Gi·ªõi h·∫°n ·∫£nh kh√°ch ƒë∆∞·ª£c ch·ªçn</label>
            <input id="maxPicks" type="number" min="1" value="20" />
          </div>
          <div>
            <label id="t_label_apikey">Google Drive API Key <span class="hint" id="t_label_apikey_hint">(y√™u c·∫ßu b·∫≠t Drive API & cho folder ·ªü ch·∫ø ƒë·ªô Anyone with link)</span></label>
            <input id="apiKey" placeholder="AIza..."/>
          </div>
          <div>
            <label id="t_label_folder">Google Drive Folder ID</label>
            <input id="folderId" class="mono" placeholder="D√°n URL th∆∞ m·ª•c ho·∫∑c ID‚Ä¶"/>
          </div>
          <div>
            <label id="t_label_pw">M·∫≠t kh·∫©u truy c·∫≠p (kh√°ch s·∫Ω nh·∫≠p)</label>
            <input id="password" type="password" placeholder="ƒê·∫∑t m·∫≠t kh·∫©u"/>
          </div>
          <div>
            <label id="t_label_exp">Ng√†y h·∫øt h·∫°n (kh√¥ng b·∫Øt bu·ªôc)</label>
            <input id="expiry" type="date"/>
          </div>
        </div>
        <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap">
          <button class="iconbtn" id="btnGen" title="T·∫°o link"><svg viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></button>
          <button class="iconbtn" id="btnPreview" title="Xem th·ª≠ gallery"><svg viewBox="0 0 24 24" fill="none"><path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7z"/><circle cx="12" cy="12" r="3" fill="currentColor"/></svg></button>
          <button class="iconbtn" id="btnCopyLink" title="Copy link"><svg viewBox="0 0 24 24" fill="none"><path d="M10 13a5 5 0 0 0 7.07 0l2.12-2.12a5 5 0 1 0-7.07-7.07L10.5 5M14 11a5 5 0 0 0-7.07 0L4.8 13.12a5 5 0 1 0 7.07 7.07L13.5 19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
        </div>
        <div id="genResult" class="hint" style="margin-top:12px"></div>
        <div class="sep"></div>
        <details>
          <summary id="t_guide_title"><strong>H∆∞·ªõng d·∫´n l·∫•y API Key & Folder ID</strong></summary>
          <ol class="small" id="t_guide_list">
            <li>M·ªü <a href="https://console.cloud.google.com/" target="_blank">Google Cloud Console</a> ‚Üí t·∫°o Project ‚Üí b·∫≠t <em>Google Drive API</em> ‚Üí t·∫°o <em>API Key</em>.</li>
            <li>Tr√™n Google Drive, ƒë·ªÉ folder ch·ª©a ·∫£nh ·ªü ch·∫ø ƒë·ªô <em>Anyone with the link ‚Äì Viewer</em>.</li>
            <li>C√≥ th·ªÉ d√°n URL th∆∞ m·ª•c (code t·ª± t√°ch ID) ho·∫∑c d√°n ID tr·ª±c ti·∫øp.</li>
          </ol>
        </details>
        <p class="small danger" id="t_sec_warn">C·∫£nh b√°o b·∫£o m·∫≠t: Trang n√†y l√† static (kh√¥ng c√≥ server). Password ch·ªâ ƒë∆∞·ª£c ki·ªÉm tra trong tr√¨nh duy·ªát; ng∆∞·ªùi am hi·ªÉu c√≥ th·ªÉ ƒë·ªçc token. D√πng nh∆∞ m·ªôt l·ªõp ‚Äúkh√≥a nh·∫π‚Äù.</p>
      </div>
    </div>

    <!-- CLIENT -->
    <div id="clientView" class="hidden">
      <div class="card" id="gate">
        <h2 id="albumTitle">Album</h2>
        <p class="hint" id="albumMeta">Nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ m·ªü album.</p>
        <div class="row">
          <div>
            <label id="t_pw_label">M·∫≠t kh·∫©u</label>
            <input id="pwInput" type="password" placeholder="Nh·∫≠p m·∫≠t kh·∫©u b·∫°n ƒë√£ nh·∫≠n" />
          </div>
          <div style="display:flex;align-items:end">
            <button class="iconbtn" id="btnOpen" title="M·ªü album">
              <svg viewBox="0 0 24 24" fill="none"><path d="M3 12h18M13 5l7 7-7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </button>
          </div>
        </div>
        <p id="pwMsg" class="small"></p>
      </div>

      <div id="albumArea" class="hidden">
        <div class="card" style="display:flex; align-items:center; justify-content:space-between; gap:12px">
          <div>
            <h2 id="liveTitle" style="margin:0 0 4px"></h2>
            <div class="hint" id="liveMeta"></div>
          </div>
          <div style="display:flex; gap:10px; align-items:center">
            <div class="tag"><span id="t_selected">ƒê∆∞·ª£c ch·ªçn:</span> <span class="counter" id="pickCount">0</span>/<span id="pickMax">0</span></div>
            <button class="iconbtn" id="btnExport" title="Xu·∫•t DS (.txt)">
              <svg viewBox="0 0 24 24" fill="none"><path d="M12 3v10m0 0 4-4m-4 4-4-4M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </button>
            <button class="iconbtn" id="btnCopy" title="Copy DS">
              <svg viewBox="0 0 24 24" fill="none"><rect x="9" y="9" width="13" height="13" rx="2" stroke="currentColor" stroke-width="2"/><rect x="3" y="3" width="13" height="13" rx="2" stroke="currentColor" stroke-width="2"/></svg>
            </button>
          </div>
        </div>
        <div id="galleryWrap" class="card">
          <div class="gallery" id="gallery"></div>
          <div id="empty" class="hint hidden">Ch∆∞a t√¨m th·∫•y ·∫£nh trong th∆∞ m·ª•c n√†y.</div>
        </div>
      </div>
    </div>

    <div class="toast" id="toast"></div>
  </div>

  <footer>2025 copyright GIAUKIEN</footer>

  <script>
  // ---------- Helpers ----------
  const $ = (sel)=>document.querySelector(sel);
  const show = (el, on)=> el && el.classList[on? 'remove':'add']('hidden');
  function toast(msg){ const t=$('#toast'); if(!t) return; t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none', 2200); }
  const baseUrl = location.origin + location.pathname;

  function on(sel, evt, fn, opts){ const el = typeof sel==='string'? $(sel): sel; if(el) el.addEventListener(evt, fn, opts||{passive:true}); }

  function normalizeFolderId(s){
    if(!s) return s;
    s = s.trim();
    if(s.startsWith('http')){
      const m1 = s.match(/\/folders\/([^\/?#]+)/);
      if(m1) return m1[1];
      const m2 = s.match(/[?&]id=([^&]+)/);
      if(m2) return m2[1];
    }
    return s;
  }

  // ---------- Router ----------
  const views = {home: null, admin: null, client: null};
  function cacheViews(){ views.home=$('#homeView'); views.admin=$('#adminView'); views.client=$('#clientView'); }
  function goto(view){ Object.values(views).forEach(v=>v && show(v,false)); show(views[view], true); }
  function renderByHash(){
    const h = location.hash || '';
    if(h.startsWith('#admin')){ goto('admin'); return; }
    if(h.startsWith('#token=')) { goto('client'); initClient(decodeToken(h.slice(7))); return; }
    goto('home');
  }

  // ---------- Token ----------
  async function sha256(txt){
    const enc = new TextEncoder().encode(txt);
    const buf = await crypto.subtle.digest('SHA-256', enc);
    return [...new Uint8Array(buf)].map(x=>x.toString(16).padStart(2,'0')).join('');
  }
  function b64uEncode(obj){
    const j = JSON.stringify(obj);
    return btoa(unescape(encodeURIComponent(j))).replaceAll('+','-').replaceAll('/','_').replaceAll('=' ,'');
  }
  function b64uDecode(s){
    s = s.replaceAll('-','+').replaceAll('_','/');
    try{ return JSON.parse(decodeURIComponent(escape(atob(s)))); }catch(e){ return null }
  }

  // ---------- Admin ----------
  let lastGeneratedURL = "";
  function bindAdmin(){
    on('#btnGen','click', async ()=>{
      const album = $('#albumName')?.value.trim() || 'Album';
      const apiKey = $('#apiKey')?.value.trim();
      const folderRaw = $('#folderId')?.value.trim();
      const folderId = normalizeFolderId(folderRaw||'');
      const password = $('#password')?.value || '';
      const maxPicks = Math.max(1, parseInt($('#maxPicks')?.value||'1'));
      const expiry = $('#expiry')?.value || null;
      if(!apiKey || !folderId || !password){ toast(t('need_api')); return; }
      const pwHash = await sha256(password);
      const payload = { v:1, album, apiKey, folderId, pwHash, maxPicks, expiry };
      const token = b64uEncode(payload);
      const url = `${baseUrl}#token=${token}`;
      lastGeneratedURL = url;
      const gr = $('#genResult');
      if(gr) gr.innerHTML = `<div class="mono" style="word-break:break-all">${url}</div><div class="small">${expiry? t('may_expire')+': '+expiry:''}</div>`;
      try{ await navigator.clipboard.writeText(url); toast(t('made_and_copied')); }catch{ toast(t('made')); }
    });

    on('#btnCopyLink','click', async ()=>{
      if(!lastGeneratedURL){ toast(t('no_link')); return; }
      try{ await navigator.clipboard.writeText(lastGeneratedURL); toast(t('copied_link')); }catch{ toast(t('copy_fail')); }
    });

    on('#btnPreview','click', async ()=>{
      const apiKey = $('#apiKey')?.value.trim();
      const folderId = normalizeFolderId($('#folderId')?.value.trim()||'');
      const album = $('#albumName')?.value.trim()||'Album';
      const maxPicks = Math.max(1, parseInt($('#maxPicks')?.value||'1'));
      if(!apiKey || !folderId){ toast(t('need_api')); return; }
      const payload = { v:1, album, apiKey, folderId, pwHash:"", maxPicks, expiry:null };
      goto('client'); initClient(payload, {skipPw:true});
    });
  }

  // ---------- Client ----------
  function decodeToken(tokenStr){
    const p = b64uDecode(tokenStr);
    if(!p || !p.folderId || !p.apiKey) { toast(t('bad_token')); goto('home'); return null; }
    return p;
  }

  function initClient(payload, opts={}){
    if(!payload) return;
    const {album, maxPicks, expiry} = payload;
    $('#albumTitle').textContent = album || 'Album';
    $('#albumMeta').textContent = expiry? `${t('may_expire')} ${expiry}.` : t('enter_pw');
    $('#pickMax').textContent = maxPicks;
    show($('#gate'), !opts.skipPw);
    show($('#albumArea'), !!opts.skipPw);
    if(opts.skipPw){ loadGallery(payload); }

    on('#btnOpen','click', async ()=>{
      const pw = $('#pwInput')?.value || '';
      if(!pw){ $('#pwMsg').textContent = t('ask_pw'); return; }
      const hash = await sha256(pw);
      if(hash !== payload.pwHash){ $('#pwMsg').textContent = t('wrong_pw'); return; }
      $('#pwMsg').textContent='';
      show($('#gate'), false); show($('#albumArea'), true);
      loadGallery(payload);
    });
  }

  // ---------- Drive ----------
  async function listDriveFiles(folderId, apiKey){
    const fid = normalizeFolderId(folderId);
    const q = encodeURIComponent(`'${fid}' in parents and mimeType contains 'image/' and trashed = false`);
    const fields = encodeURIComponent('files(id,name,mimeType,thumbnailLink,webContentLink,webViewLink)');
    const url = `https://www.googleapis.com/drive/v3/files?q=${q}&key=${apiKey}&fields=${fields}&pageSize=1000&orderBy=name`;
    try{
      const res = await fetch(url);
      if(!res.ok){ throw new Error(await res.text()); }
      const {files} = await res.json();
      return files || [];
    }catch(e){
      console.error(e); toast(t('cant_list')); return [];
    }
  }
  const fileThumb = (id)=>`https://drive.google.com/thumbnail?id=${id}&sz=w1200`;
  const fileDownload = (id)=>`https://drive.google.com/uc?export=download&id=${id}`;

  // ---------- Render ----------
  function renderGallery(files, maxPicks){
    const wrap = $('#gallery'); if(!wrap) return;
    wrap.innerHTML = '';
    if(!files.length){ show($('#empty'), true); return; }
    show($('#empty'), false);

    const selected = new Set();
    const notes = new Map();
    const counter = ()=> { const el=$('#pickCount'); if(el) el.textContent = String(selected.size); };

    files.forEach((f)=>{
      const card = document.createElement('div'); card.className = 'imgCard'; card.tabIndex=0;

      const img = document.createElement('img'); img.loading='lazy'; img.alt=f.name; img.src=fileThumb(f.id);

      // filename bottom-right
      const top = document.createElement('div'); top.className='imgTop';
      const nameTag = document.createElement('div'); nameTag.className='tag mono'; nameTag.title=f.name; nameTag.textContent=f.name; top.appendChild(nameTag);

      // checkbox top-left
      const fav = document.createElement('div'); fav.className='fav';
      const cb = document.createElement('input'); cb.type='checkbox'; cb.id='cb_'+f.id; cb.setAttribute('aria-label',t('pick_photo'));

      // download top-right
      const actions = document.createElement('div'); actions.className='imgActions';
      const dl = document.createElement('a'); dl.className='dlbtn'; dl.href=fileDownload(f.id); dl.title=t('download'); dl.setAttribute('download','');
      dl.innerHTML = '<svg viewBox="0 0 24 24" fill="none"><path d="M12 3v10m0 0 4-4m-4 4-4-4M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';

      const note = document.createElement('input'); note.className='note'; note.type='text'; note.placeholder=t('note_ph');
      note.addEventListener('input', ()=>{ notes.set(f.id, note.value.trim()); });

      function toggle(){
        if(!cb.checked){
          if(selected.size >= maxPicks){ toast(t('max_picks', {n:maxPicks})); return; }
          cb.checked = true; selected.add(f.id);
        }else{
          cb.checked = false; selected.delete(f.id);
        }
        counter();
      }

      // ch·ªçn ·∫£nh khi b·∫•m v√πng tr·ªëng
      card.addEventListener('click', (e)=>{
        if(e.target === note || e.target.closest('.dlbtn') || e.target === cb) return;
        toggle();
      }, {passive:true});

      // nh·∫•n chu·ªôt ph·∫£i ƒë·ªÉ t·∫£i nhanh
      card.addEventListener('contextmenu', (e)=>{ e.preventDefault(); window.open(fileDownload(f.id),'_blank'); });

      fav.append(cb); actions.appendChild(dl);
      card.append(img, top, fav, actions, note);
      wrap.appendChild(card);
    });

    counter();

    on('#btnExport','click', ()=>{
      if(!selected.size){ toast(t('none_selected')); return; }
      const chosen = files.filter(f=>selected.has(f.id));
      const lines = chosen.map((f,i)=>{
        const idx = String(i+1).padStart(3,'0');
        const n = notes.get(f.id);
        return n ? `${idx}  ${f.name}  ‚Äî ${n}` : `${idx}  ${f.name}`;
      });
      const txt = lines.join('\n');
      const blob = new Blob([txt], {type:'text/plain;charset=utf-8'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='favorites.txt'; a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
      toast(t('downloaded_txt'));
    });

    on('#btnCopy','click', async ()=>{
      const chosen = files.filter(f=>selected.has(f.id));
      const lines = chosen.map((f,i)=>{
        const idx = String(i+1).padStart(3,'0');
        const n = notes.get(f.id);
        return n ? `${idx}  ${f.name}  ‚Äî ${n}` : `${idx}  ${f.name}`;
      });
      const txt = lines.join('\n');
      try{ await navigator.clipboard.writeText(txt); toast(t('copied_list')); } catch{ toast(t('copy_fail')); }
    });
  }

  async function loadGallery(p){
    $('#liveTitle').textContent = p.album || 'Album';
    $('#liveMeta').textContent = `${t('folder')}: ${normalizeFolderId(p.folderId)}`;
    const list = await listDriveFiles(p.folderId, p.apiKey);
    renderGallery(list, p.maxPicks);
  }

  // ---------- Theme (single definition) ----------
  const toggleThemeBtn = $('#toggleTheme');
  function applyTheme(theme){ // 'light' | 'dark'
    const root = document.documentElement;
    root.classList.toggle('light', theme==='light');
    localStorage.setItem('cg_theme', theme);
  }
  on(toggleThemeBtn,'click', ()=>{
    const cur = localStorage.getItem('cg_theme') || 'dark';
    applyTheme(cur==='dark'?'light':'dark');
  });
  applyTheme(localStorage.getItem('cg_theme') || 'dark');

  // ---------- i18n ----------
  const I18N = {
    vi:{ home_title:"Share album cho kh√°ch", home_hint:"Single-file ¬∑ ch·∫°y tr√™n GIAUKIEN ¬∑ d√πng Google Drive ƒë·ªÉ l∆∞u ·∫£nh ¬∑ kh√°ch xem/ t·∫£i/ ch·ªçn ·∫£nh y√™u th√≠ch.",
      make_title:"T·∫°o link cho kh√°ch", make_desc:'V√†o ph·∫ßn <strong>T·∫°o link</strong> ƒë·ªÉ nh·∫≠p <em>API Key</em>, <em>Folder ID</em> c·ªßa Google Drive, ƒë·∫∑t <em>m·∫≠t kh·∫©u</em> v√† <em>gi·ªõi h·∫°n s·ªë ·∫£nh ƒë∆∞·ª£c ch·ªçn</em>. H·ªá th·ªëng s·∫Ω t·∫°o URL ri√™ng g·ª≠i cho kh√°ch.',
      make_note:"L∆∞u √Ω: v√¨ ch·∫°y tƒ©nh tr√™n Pages, m·∫≠t kh·∫©u ch·ªâ ki·ªÉm tra ·ªü tr√¨nh duy·ªát (kh√¥ng ch·ªëng ƒë∆∞·ª£c ng∆∞·ªùi r√†nh k·ªπ thu·∫≠t). N·∫øu b·∫°n c·∫ßn b·∫£o v·ªá th·∫≠t s·ª±, n√™n d√πng server/ serverless.",
      client_title:"Kh√°ch truy c·∫≠p", client_desc:"N·∫øu b·∫°n l√† kh√°ch, b·∫°n s·∫Ω nh·∫≠n 1 ƒë∆∞·ªùng link. M·ªü link, nh·∫≠p m·∫≠t kh·∫©u l√† th·∫•y ·∫£nh.",
      admin_title:"Tr√¨nh t·∫°o link cho kh√°ch", label_album:"T√™n album", label_limit:"Gi·ªõi h·∫°n ·∫£nh kh√°ch ƒë∆∞·ª£c ch·ªçn",
      label_apikey:"Google Drive API Key", label_apikey_hint:"(y√™u c·∫ßu b·∫≠t Drive API & cho folder ·ªü ch·∫ø ƒë·ªô Anyone with link)",
      label_folder:"Google Drive Folder ID", label_pw:"M·∫≠t kh·∫©u truy c·∫≠p (kh√°ch s·∫Ω nh·∫≠p)", label_exp:"Ng√†y h·∫øt h·∫°n (kh√¥ng b·∫Øt bu·ªôc)",
      guide_title:"H∆∞·ªõng d·∫´n l·∫•y API Key & Folder ID",
      guide_list:`<li>M·ªü <a href="https://console.cloud.google.com/" target="_blank">Google Cloud Console</a> ‚Üí t·∫°o Project ‚Üí b·∫≠t <em>Google Drive API</em> ‚Üí t·∫°o <em>API Key</em>.</li>
                  <li>Tr√™n Google Drive, ƒë·ªÉ folder ch·ª©a ·∫£nh ·ªü ch·∫ø ƒë·ªô <em>Anyone with the link ‚Äì Viewer</em>.</li>
                  <li>C√≥ th·ªÉ d√°n URL th∆∞ m·ª•c (code t·ª± t√°ch ID) ho·∫∑c d√°n ID tr·ª±c ti·∫øp.</li>`,
      sec_warn:"C·∫£nh b√°o b·∫£o m·∫≠t: Trang n√†y l√† static (kh√¥ng c√≥ server). Password ch·ªâ ƒë∆∞·ª£c ki·ªÉm tra trong tr√¨nh duy·ªát; ng∆∞·ªùi am hi·ªÉu c√≥ th·ªÉ ƒë·ªçc token. D√πng nh∆∞ m·ªôt l·ªõp ‚Äúkh√≥a nh·∫π‚Äù.",
      pw_label:"M·∫≠t kh·∫©u", enter_pw:"Nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ m·ªü album.", may_expire:"Link c√≥ th·ªÉ h·∫øt h·∫°n sau ng√†y", ask_pw:"Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u",
      wrong_pw:"Sai m·∫≠t kh·∫©u", selected:"ƒê∆∞·ª£c ch·ªçn:", note_ph:"Ghi ch√∫‚Ä¶ (v√≠ d·ª•: ch·ªânh s√°ng, c·∫Øt 4x5, x√≥a v·∫≠t th·ªÉ‚Ä¶)", pick_photo:"Ch·ªçn ·∫£nh",
      folder:"Th∆∞ m·ª•c", need_api:"Vui l√≤ng nh·∫≠p API Key, Folder ID, m·∫≠t kh·∫©u", made_and_copied:"ƒê√£ t·∫°o link & copy v√†o clipboard",
      made:"ƒê√£ t·∫°o link", no_link:"Ch∆∞a c√≥ link. Nh·∫•n ‚ÄúT·∫°o link‚Äù tr∆∞·ªõc.", copied_link:"ƒê√£ copy link", copy_fail:"Copy th·∫•t b·∫°i",
      bad_token:"Token kh√¥ng h·ª£p l·ªá.", cant_list:"Kh√¥ng th·ªÉ t·∫£i danh s√°ch ·∫£nh. Ki·ªÉm tra API Key/ quy·ªÅn chia s·∫ª folder.",
      max_picks: ({n})=>`T·ªëi ƒëa ${n} ·∫£nh`, none_selected:"Ch∆∞a ch·ªçn ·∫£nh n√†o", downloaded_txt:"ƒê√£ t·∫£i favorites.txt",
      copied_list:"ƒê√£ copy danh s√°ch", download:"T·∫£i ·∫£nh",
    },
    en:{ home_title:"Share client album", home_hint:"Single-file on GIAUKIEN ¬∑ Photos on Google Drive ¬∑ Clients can view / download / favorite.",
      make_title:"Create client link", make_desc:'Open <strong>Create link</strong> to enter <em>API Key</em>, <em>Folder ID</em>, set <em>password</em> and <em>pick limit</em>. A private URL will be created for your client.',
      make_note:"Note: this is a static page. Password is client-side only. For strong protection, use a server/serverless backend.",
      client_title:"Client access", client_desc:"Clients receive a link. Open it, enter password, and view photos.",
      admin_title:"Link builder", label_album:"Album name", label_limit:"Pick limit", label_apikey:"Google Drive API Key",
      label_apikey_hint:"(enable Drive API & set folder to Anyone with link)", label_folder:"Google Drive Folder ID",
      label_pw:"Access password (client enters)", label_exp:"Expiry date (optional)", guide_title:"How to get API Key & Folder ID",
      guide_list:`<li>Open <a href="https://console.cloud.google.com/" target="_blank">Google Cloud Console</a> ‚Üí create a Project ‚Üí enable <em>Google Drive API</em> ‚Üí create an <em>API Key</em>.</li>
                  <li>On Google Drive, set the folder to <em>Anyone with the link ‚Äì Viewer</em>.</li>
                  <li>Paste the folder URL (auto-extract ID) or paste the ID directly.</li>`,
      sec_warn:"Security note: this is static (no server). Password check runs in the browser.",
      pw_label:"Password", enter_pw:"Enter the password to open the album.", may_expire:"Link may expire after",
      ask_pw:"Please enter the password", wrong_pw:"Wrong password", selected:"Selected:",
      note_ph:"Notes‚Ä¶ (e.g., brighten, crop 4x5, remove object‚Ä¶)", pick_photo:"Pick photo",
      folder:"Folder", need_api:"Please fill API Key, Folder ID and password", made_and_copied:"Link created & copied",
      made:"Link created", no_link:"No link yet. Click ‚ÄúCreate link‚Äù first.", copied_link:"Link copied", copy_fail:"Copy failed",
      bad_token:"Invalid token.", cant_list:"Cannot list images. Check API key/folder sharing.",
      max_picks: ({n})=>`Max ${n} photos`, none_selected:"No photo selected", downloaded_txt:"Downloaded favorites.txt",
      copied_list:"List copied", download:"Download",
    },
    kh:{ home_title:"·ûÖ·üÇ·ûÄ·ûö·üÜ·ûõ·üÇ·ûÄ Album ·û¢·ûè·û∑·ûê·û∑·ûá·ûì", home_hint:"·ûØ·ûÄ·ûü·û∂·ûö‚Äã·ûè·üÇ·ûò·ûΩ·ûô ¬∑ ·ûö·ûÄ·üí·ûü·û∂·ûë·ûª·ûÄ·ûö·ûº·ûî·ûì·üÖ Google Drive ¬∑ ·û¢·ûè·û∑·ûê·û∑·ûá·ûì·û¢·û∂·ûÖ‚Äã·ûò·ûæ·ûõ/·ûë·û∂·ûâ·ûô·ûÄ/·ûá·üí·ûö·ûæ·ûü·üî",
      make_title:"·ûî·ûÑ·üí·ûÄ·ûæ·ûè link ·û¢·ûè·û∑·ûê·û∑·ûá·ûì", make_desc:'·ûî·ûâ·üí·ûÖ·ûº·ûõ <strong>API Key</strong>, <strong>Folder ID</strong>, ·ûÄ·üÜ·ûé·ûè·üã <strong>·ûñ·û∂·ûÄ·üí·ûô·ûü·ûò·üí·ûÑ·û∂·ûè·üã</strong> ·ûì·û∑·ûÑ <strong>·ûÖ·üÜ·ûì·ûΩ·ûì·ûö·ûº·ûî·û¢·û∂·ûÖ·ûá·üí·ûö·ûæ·ûü</strong>·üî ·ûî·üí·ûö·ûñ·üê·ûì·üí·ûí·ûì·ûπ·ûÑ·ûî·ûÑ·üí·ûÄ·ûæ·ûè link ·û≤·üí·ûô·û¢·ûè·û∑·ûê·û∑·ûá·ûì·üî',
      make_note:"·ûÖ·üÜ·ûé·û∂·üÜ: ·ûÇ·üÅ·ûî·ûé·üí·ûä·û∂·ûâ static, ·ûñ·û∂·ûÄ·üí·ûô·ûü·ûò·üí·ûÑ·û∂·ûè·üã·ûè·üí·ûö·ûº·ûú·ûî·û∂·ûì·ûñ·û∑·ûì·û∑·ûè·üí·ûô·ûì·üÖ·ûÅ·û∂·ûÑ·ûò·üâ·û∂·ûü·ûª·û∏·ûì·ûó·üí·ûâ·üÄ·ûú·üî ·ûè·üí·ûö·ûº·ûú·ûÄ·û∂·ûö‚Äã·ûü·ûª·ûú·ûè·üí·ûê·û∑·ûó·û∂·ûñ·ûÅ·üí·ûñ·ûü·üã ·ûü·ûº·ûò·ûî·üí·ûö·ûæ server/serverless·üî",
      client_title:"·û¢·ûè·û∑·ûê·û∑·ûá·ûì·ûÖ·ûº·ûõ·ûò·ûæ·ûõ", client_desc:"·û¢·ûè·û∑·ûê·û∑·ûá·ûì·ûì·ûπ·ûÑ·ûë·ûë·ûΩ·ûõ·ûî·û∂·ûì link·üî ·ûî·ûæ·ûÄ ·ûì·û∑·ûÑ·ûî·ûâ·üí·ûÖ·ûº·ûõ·ûñ·û∂·ûÄ·üí·ûô·ûü·ûò·üí·ûÑ·û∂·ûè·üã ·ûä·ûæ·ûò·üí·ûî·û∏·ûò·ûæ·ûõ·ûö·ûº·ûî·üî",
      admin_title:"·ûÇ·üí·ûö·ûî·üã·ûÇ·üí·ûö·ûÑ·ûî·ûÑ·üí·ûÄ·ûæ·ûè·ûè·üÜ·ûé", label_album:"·ûà·üí·ûò·üÑ·üá·û¢·û∂·ûõ·üã·ûî·üä·ûª·üÜ", label_limit:"·ûÄ·üÜ·ûé·ûè·üã·ûÖ·üÜ·ûì·ûΩ·ûì·ûá·üí·ûö·ûæ·ûü", label_apikey:"Google Drive API Key",
      label_apikey_hint:"(·ûî·ûæ·ûÄ Drive API ·ûì·û∑·ûÑ·ûÄ·üÜ·ûé·ûè·üã·ûê·ûè Anyone with link)", label_folder:"Google Drive Folder ID",
      label_pw:"·ûñ·û∂·ûÄ·üí·ûô·ûü·ûò·üí·ûÑ·û∂·ûè·üã", label_exp:"·ûÄ·û∂·ûõ·ûî·ûö·û∑·ûÖ·üí·ûÜ·üÅ·ûë·ûï·ûª·ûè·ûÄ·üÜ·ûé·ûè·üã (·ûò·û∑·ûì·ûî·ûÑ·üí·ûÅ·üÜ)", guide_title:"·ûö·ûî·üÄ·ûî·ûô·ûÄ API Key & Folder ID",
      guide_list:`<li>·ûî·ûæ·ûÄ <a href="https://console.cloud.google.com/" target="_blank">Google Cloud Console</a> ‚Üí ·ûî·ûÑ·üí·ûÄ·ûæ·ûè Project ‚Üí ·ûî·ûæ·ûÄ <em>Google Drive API</em> ‚Üí ·ûî·ûÑ·üí·ûÄ·ûæ·ûè <em>API Key</em>.</li>
                  <li>·ûÄ·üÜ·ûé·ûè·üã·ûê·ûè Drive ·ûá·û∂ <em>Anyone with the link ‚Äì Viewer</em>.</li>
                  <li>·ûî·û∑·ûë·ûó·üí·ûá·û∂·ûî·üã URL ·ûê·ûè ·û¨ ID ·ûä·üÑ·ûô·ûï·üí·ûë·û∂·ûõ·üã·üî</li>`,
      sec_warn:"·ûÄ·û∂·ûö·ûñ·üí·ûö·ûò·û∂·ûì·ûü·ûª·ûú·ûè·üí·ûê·û∑·ûó·û∂·ûñ: ·ûÇ·üÅ·ûî·ûé·üí·ûä·û∂·ûâ static (·ûÇ·üí·ûò·û∂·ûì server)·üî",
      pw_label:"·ûñ·û∂·ûÄ·üí·ûô·ûü·ûò·üí·ûÑ·û∂·ûè·üã", enter_pw:"·ûî·ûâ·üí·ûÖ·ûº·ûõ·ûñ·û∂·ûÄ·üí·ûô·ûü·ûò·üí·ûÑ·û∂·ûè·üã·ûä·ûæ·ûò·üí·ûî·û∏·ûî·ûæ·ûÄ·û¢·û∂·ûõ·üã·ûî·üä·ûª·üÜ·üî", may_expire:"·ûè·üÜ·ûé·û¢·û∂·ûÖ·ûï·ûª·ûè·ûÄ·üÜ·ûé·ûè·üã·ûÄ·üí·ûö·üÑ·ûô·ûê·üí·ûÑ·üÉ",
      ask_pw:"·ûü·ûº·ûò·ûî·ûâ·üí·ûÖ·ûº·ûõ·ûñ·û∂·ûÄ·üí·ûô·ûü·ûò·üí·ûÑ·û∂·ûè·üã", wrong_pw:"·ûñ·û∂·ûÄ·üí·ûô·ûü·ûò·üí·ûÑ·û∂·ûè·üã·ûò·û∑·ûì·ûè·üí·ûö·ûπ·ûò·ûè·üí·ûö·ûº·ûú",
      selected:"·ûî·û∂·ûì·ûá·üí·ûö·ûæ·ûü:", note_ph:"·ûÄ·üÜ·ûé·ûè·üã·ûÖ·üÜ·ûé·û∂·üÜ‚Ä¶", pick_photo:"·ûá·üí·ûö·ûæ·ûü·ûö·ûæ·ûü·ûö·ûº·ûî",
      folder:"·ûê·ûè", need_api:"·ûü·ûº·ûò·ûî·üÜ·ûñ·üÅ·ûâ API Key, Folder ID ·ûì·û∑·ûÑ ·ûñ·û∂·ûÄ·üí·ûô·ûü·ûò·üí·ûÑ·û∂·ûè·üã",
      made_and_copied:"·ûî·û∂·ûì·ûî·ûÑ·üí·ûÄ·ûæ·ûè·ûè·üÜ·ûé ·ûì·û∑·ûÑ·ûÖ·ûò·üí·ûõ·ûÑ", made:"·ûî·û∂·ûì·ûî·ûÑ·üí·ûÄ·ûæ·ûè·ûè·üÜ·ûé", no_link:"·ûò·û∑·ûì·ûë·û∂·ûì·üã·ûò·û∂·ûì·ûè·üÜ·ûé·ûë·üÅ·üî ·ûü·ûº·ûò·ûÖ·ûª·ûÖ ‚Äú·ûî·ûÑ·üí·ûÄ·ûæ·ûè·ûè·üÜ·ûé‚Äù ·ûò·ûª·ûì·üî",
      copied_link:"·ûî·û∂·ûì·ûÖ·ûò·üí·ûõ·ûÑ·ûè·üÜ·ûé", copy_fail:"·ûÖ·ûò·üí·ûõ·ûÑ·ûî·ûö·û∂·ûá·üê·ûô", bad_token:"Token ·ûò·û∑·ûì·ûè·üí·ûö·ûπ·ûò·ûè·üí·ûö·ûº·ûú",
      cant_list:"·ûò·û∑·ûì·û¢·û∂·ûÖ·ûî·ûÑ·üí·û†·û∂·ûâ·ûî·ûâ·üí·ûá·û∏·ûö·ûº·ûî·ûó·û∂·ûñ·ûî·û∂·ûì·ûë·üÅ·üî",
      max_picks: ({n})=>`·û¢·ûè·û∑·ûî·ûö·ûò·û∂ ${n} ·ûö·ûº·ûî`, none_selected:"·ûò·û∑·ûì·ûò·û∂·ûì·ûö·ûº·ûî·ûä·üÇ·ûõ·ûî·û∂·ûì·ûá·üí·ûö·ûæ·ûü",
      downloaded_txt:"·ûî·û∂·ûì·ûë·û∂·ûâ·ûô·ûÄ favorites.txt", copied_list:"·ûî·û∂·ûì·ûÖ·ûò·üí·ûõ·ûÑ·ûî·ûâ·üí·ûá·û∏", download:"·ûë·û∂·ûâ·ûô·ûÄ",
    }
  };

  function t(key, params){
    const lang = document.documentElement.getAttribute('data-lang') || 'vi';
    const value = I18N[lang][key];
    return typeof value === 'function' ? value(params||{}) : value;
  }

  function applyLang(lang){
    document.documentElement.setAttribute('data-lang', lang);
    localStorage.setItem('cg_lang', lang);
    // Home
    $('#t_home_title').textContent = t('home_title');
    $('#t_home_hint').textContent = t('home_hint');
    $('#t_card_make_title').textContent = t('make_title');
    $('#t_card_make_desc').innerHTML = t('make_desc');
    $('#t_card_make_note').textContent = t('make_note');
    $('#t_card_client_title').textContent = t('client_title');
    $('#t_card_client_desc').textContent = t('client_desc');
    // Admin labels
    $('#t_admin_title').textContent = t('admin_title');
    $('#t_label_album').textContent = t('label_album');
    $('#t_label_limit').textContent = t('label_limit');
    $('#t_label_apikey').childNodes[0].nodeValue = t('label_apikey')+' ';
    $('#t_label_apikey_hint').textContent = t('label_apikey_hint');
    $('#t_label_folder').textContent = t('label_folder');
    $('#t_label_pw').textContent = t('label_pw');
    $('#t_label_exp').textContent = t('label_exp');
    $('#t_guide_title').innerHTML = `<strong>${t('guide_title')}</strong>`;
    $('#t_guide_list').innerHTML = t('guide_list');
    $('#t_sec_warn').textContent = t('sec_warn');
    // Client gate
    $('#albumMeta').textContent = t('enter_pw');
    $('#t_pw_label').textContent = t('pw_label');
    $('#t_selected').textContent = t('selected');

    // C·∫≠p nh·∫≠t tooltip/aria cho n√∫t ng√¥n ng·ªØ
    const langNames = {vi:'Ti·∫øng Vi·ªát', en:'English', kh:'·ûó·û∂·ûü·û∂·ûÅ·üí·ûò·üÇ·ûö'};
    const btn = $('#toggleLang');
    if(btn){ btn.title = langNames[lang]; btn.setAttribute('aria-label', langNames[lang]); }
  }

  // Lang menu toggle + ch·ªçn ng√¥n ng·ªØ
  const langBtn = $('#toggleLang');
  const langMenu = $('#langMenu');
  on(langBtn,'click', (e)=>{ e.stopPropagation(); langMenu.classList.toggle('hidden'); });
  document.addEventListener('click', (e)=>{
    if(!langMenu.contains(e.target) && e.target!==langBtn){ langMenu.classList.add('hidden'); }
  });
  document.querySelectorAll('.langItem').forEach(b=>{
    b.addEventListener('click', ()=>{
      applyLang(b.getAttribute('data-lang'));
      langMenu.classList.add('hidden');
    }, {passive:true});
  });

  // Kh·ªüi t·∫°o ng√¥n ng·ªØ (∆∞u ti√™n l∆∞u, r·ªìi theo navigator)
  (function initLang(){
    let init = localStorage.getItem('cg_lang');
    if(!init){
      const nav = (navigator.language || 'vi').toLowerCase();
      if(nav.startsWith('en')) init='en';
      else if(nav.startsWith('km') || nav.startsWith('kh')) init='kh';
      else init='vi';
    }
    applyLang(init);
  })();

  // ---------- Nav ----------
  function bindNav(){
    on('#goHome','click', ()=>{ location.hash=''; renderByHash(); });
    on('#goAdmin','click', ()=>{ location.hash='#admin'; renderByHash(); });
    on('#ctaAdmin','click', ()=>{ location.hash='#admin'; renderByHash(); });
  }

  // ---------- Boot ----------
  function bindAll(){
    cacheViews(); bindNav(); bindAdmin();
    window.addEventListener('hashchange', renderByHash, {passive:true});
    renderByHash();
  }
  document.addEventListener('DOMContentLoaded', bindAll);
  </script>
</body>
</html>
